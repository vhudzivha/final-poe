@model CMCS.Models.ClaimViewModel
@{
    ViewData["Title"] = "Submit Claims";
}

<div class="row">
    <div class="col-12">
        <h2 class="mb-4" style="color: white; font-weight: bold;">Submit Monthly Claim</h2>
    </div>
</div>

<div class="row">
    <div class="col-12">
        <div class="card-custom">
            <div class="card-header" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; padding: 15px; border-radius: 15px 15px 0 0;">
                <h5 class="mb-0">Claim Information - Automated Calculation & Validation</h5>
            </div>
            <div class="card-body p-4">
                <form asp-action="SubmitClaim" asp-controller="Home" method="post" enctype="multipart/form-data" id="claimForm">
                    @Html.AntiForgeryToken()

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label fw-bold">Claim Period <span class="text-danger">*</span></label>
                            <input name="ClaimPeriod" type="month" class="form-control form-control-custom" id="claimPeriod" required />
                            <small class="text-danger" id="periodError"></small>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-bold">Module/Course Code <span class="text-danger">*</span></label>
                            <input name="ModuleCode" type="text" class="form-control form-control-custom"
                                   placeholder="e.g., PROG6212" id="moduleCode" required
                                   pattern="[A-Z]{4}[0-9]{4}" />
                            <small class="text-muted">Format: 4 letters + 4 numbers (e.g., PROG6212)</small>
                            <small class="text-danger d-block" id="moduleError"></small>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label fw-bold">Hours Worked <span class="text-danger">*</span></label>
                            <input name="HoursWorked" type="number" step="0.5" class="form-control form-control-custom"
                                   placeholder="Enter total hours" id="hoursWorked" min="0.5" max="200" required />
                            <small class="text-muted">Maximum 200 hours per month</small>
                            <small class="text-danger d-block" id="hoursError"></small>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-bold">Hourly Rate (R) <span class="text-danger">*</span></label>
                            <input name="HourlyRate" type="number" step="0.01" class="form-control form-control-custom"
                                   placeholder="Enter hourly rate" id="hourlyRate" min="1" max="5000" required />
                            <small class="text-muted">Maximum R5000 per hour</small>
                            <small class="text-danger d-block" id="rateError"></small>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold">Description of Work Performed <span class="text-danger">*</span></label>
                        <textarea name="WorkDescription" class="form-control form-control-custom" rows="4"
                                  placeholder="Provide detailed description of lectures, tutorials, marking, etc."
                                  id="workDescription" minlength="20" maxlength="1000" required></textarea>
                        <small class="text-muted">Minimum 20 characters required (<span id="charCount">0</span>/1000)</small>
                        <small class="text-danger d-block" id="descError"></small>
                    </div>

                    <div class="mb-4">
                        <label class="form-label fw-bold">Supporting Documents</label>
                        <div class="border border-2 border-dashed rounded p-4 text-center"
                             style="border-color: #e9ecef !important; background-color: #f8f9fa; cursor: pointer;"
                             onclick="document.getElementById('fileUpload').click();">
                            <div class="mb-2">
                                <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" fill="currentColor" class="text-muted" viewBox="0 0 16 16">
                                    <path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z" />
                                    <path d="M7.646 1.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 2.707V11.5a.5.5 0 0 1-1 0V2.707L5.354 4.854a.5.5 0 1 1-.708-.708l3-3z" />
                                </svg>
                            </div>
                            <p class="mb-2" id="uploadText">Click to upload or drag and drop files here</p>
                            <p class="small text-muted mb-0">PDF, DOC, DOCX, JPG, PNG (Max 10MB per file)</p>
                        </div>
                        <input type="file" name="documents" id="fileUpload" class="d-none" multiple
                               accept=".pdf,.doc,.docx,.jpg,.jpeg,.png" />
                        <small class="text-danger d-block" id="fileError"></small>
                    </div>

                    <!-- AUTOMATED CALCULATION DISPLAY -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <div class="card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                                <div class="card-body">
                                    <h5 class="mb-3">💰 Automated Calculation</h5>
                                    <div class="row">
                                        <div class="col-md-4 text-center">
                                            <small>Hours Worked</small>
                                            <h3 id="displayHours">0</h3>
                                        </div>
                                        <div class="col-md-4 text-center">
                                            <small>Hourly Rate</small>
                                            <h3>R<span id="displayRate">0.00</span></h3>
                                        </div>
                                        <div class="col-md-4 text-center">
                                            <small>Total Amount</small>
                                            <h2 class="text-warning"><strong>R<span id="totalAmount">0.00</span></strong></h2>
                                        </div>
                                    </div>
                                    <div class="progress mt-3" style="height: 5px;">
                                        <div class="progress-bar bg-warning" role="progressbar" id="amountProgress" style="width: 0%"></div>
                                    </div>
                                    <small class="d-block mt-2 text-center" id="validationStatus">
                                        <span class="badge bg-secondary">Enter values to calculate</span>
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="d-flex gap-3">
                        <button type="submit" class="btn btn-custom" id="submitBtn" disabled>
                            <span id="submitText">Submit Claim</span>
                        </button>
                        <button type="button" class="btn btn-outline-secondary">
                            Save as Draft
                        </button>
                        <a asp-action="Dashboard" asp-controller="Home" class="btn btn-outline-primary">
                            Cancel
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function () {
            let validationState = {
                period: false,
                module: false,
                hours: false,
                rate: false,
                description: false
            };

            // AUTOMATED CALCULATION WITH VALIDATION
            function calculateAndValidate() {
                var hours = parseFloat($('#hoursWorked').val()) || 0;
                var rate = parseFloat($('#hourlyRate').val()) || 0;
                var total = hours * rate;

                // Update display
                $('#displayHours').text(hours.toFixed(1));
                $('#displayRate').text(rate.toFixed(2));
                $('#totalAmount').text(total.toFixed(2));

                // Update progress bar
                var maxAmount = 200 * 5000; // Max possible
                var percentage = Math.min((total / maxAmount) * 100, 100);
                $('#amountProgress').css('width', percentage + '%');

                // Validation status
                if (total > 0 && total <= 1000000) {
                    $('#validationStatus').html('<span class="badge bg-success">✓ Valid amount: R' + total.toFixed(2) + '</span>');
                } else if (total > 1000000) {
                    $('#validationStatus').html('<span class="badge bg-danger">⚠ Amount exceeds maximum limit</span>');
                } else {
                    $('#validationStatus').html('<span class="badge bg-secondary">Enter values to calculate</span>');
                }

                updateSubmitButton();
            }

            // REAL-TIME VALIDATION
            $('#claimPeriod').on('change', function () {
                var selectedDate = new Date($(this).val());
                var today = new Date();

                if (selectedDate > today) {
                    $('#periodError').text('Cannot submit claims for future periods');
                    validationState.period = false;
                } else {
                    $('#periodError').text('');
                    validationState.period = true;
                }
                updateSubmitButton();
            });

            $('#moduleCode').on('input', function () {
                var code = $(this).val().toUpperCase();
                $(this).val(code);

                var pattern = /^[A-Z]{4}[0-9]{4}$/;
                if (code.length > 0 && !pattern.test(code)) {
                    $('#moduleError').text('Format must be: 4 letters + 4 numbers (e.g., PROG6212)');
                    validationState.module = false;
                } else if (pattern.test(code)) {
                    $('#moduleError').text('');
                    validationState.module = true;
                } else {
                    $('#moduleError').text('');
                    validationState.module = false;
                }
                updateSubmitButton();
            });

            $('#hoursWorked').on('input', function () {
                var hours = parseFloat($(this).val()) || 0;

                if (hours < 0.5) {
                    $('#hoursError').text('Minimum 0.5 hours required');
                    validationState.hours = false;
                } else if (hours > 200) {
                    $('#hoursError').text('Maximum 200 hours per month allowed');
                    validationState.hours = false;
                } else {
                    $('#hoursError').text('');
                    validationState.hours = true;
                }
                calculateAndValidate();
            });

            $('#hourlyRate').on('input', function () {
                var rate = parseFloat($(this).val()) || 0;

                if (rate < 1) {
                    $('#rateError').text('Minimum rate is R1.00');
                    validationState.rate = false;
                } else if (rate > 5000) {
                    $('#rateError').text('Maximum rate is R5000.00');
                    validationState.rate = false;
                } else {
                    $('#rateError').text('');
                    validationState.rate = true;
                }
                calculateAndValidate();
            });

            $('#workDescription').on('input', function () {
                var length = $(this).val().length;
                $('#charCount').text(length);

                if (length < 20) {
                    $('#descError').text('Minimum 20 characters required (' + length + '/20)');
                    validationState.description = false;
                } else if (length > 1000) {
                    $('#descError').text('Maximum 1000 characters exceeded');
                    validationState.description = false;
                } else {
                    $('#descError').text('');
                    validationState.description = true;
                }
                updateSubmitButton();
            });

            // FILE VALIDATION
            $('#fileUpload').change(function () {
                var files = this.files;
                var errors = [];
                var validFiles = [];

                for (var i = 0; i < files.length; i++) {
                    var file = files[i];
                    var fileSize = file.size / 1024 / 1024; // MB
                    var ext = file.name.split('.').pop().toLowerCase();

                    if (fileSize > 10) {
                        errors.push(file.name + ' is too large (' + fileSize.toFixed(2) + 'MB)');
                    } else if (!['pdf', 'doc', 'docx', 'jpg', 'jpeg', 'png'].includes(ext)) {
                        errors.push(file.name + ' has invalid file type');
                    } else {
                        validFiles.push(file.name);
                    }
                }

                if (errors.length > 0) {
                    $('#fileError').html(errors.join('<br>'));
                } else {
                    $('#fileError').text('');
                }

                if (validFiles.length > 0) {
                    $('#uploadText').html('<strong class="text-success">✓ ' + validFiles.length + ' file(s) ready to upload</strong>');
                }
            });

            function updateSubmitButton() {
                var allValid = validationState.period && validationState.module &&
                    validationState.hours && validationState.rate &&
                    validationState.description;

                $('#submitBtn').prop('disabled', !allValid);

                if (allValid) {
                    $('#submitBtn').removeClass('btn-secondary').addClass('btn-custom');
                    $('#submitText').text('✓ Submit Claim');
                } else {
                    $('#submitBtn').removeClass('btn-custom').addClass('btn-secondary');
                    $('#submitText').text('Complete all required fields');
                }
            }

            // Form submission
            $('#claimForm').on('submit', function (e) {
                if ($('#submitBtn').prop('disabled')) {
                    e.preventDefault();
                    alert('Please correct all validation errors before submitting.');
                }
            });
        });
    </script>
}
